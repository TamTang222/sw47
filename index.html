<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>locationTrace</title>
</head>
<body>
    <p><button onclick="startMonitoring()">Start Monitoring</button></p>
    <div id="out"></div>

    <script>
        var output = document.getElementById("out");
        var watchId;

        if (!navigator.geolocation) {
            output.innerHTML = "<p>Geolocation is not supported by your browser</p>";
        }

        function success(position) {
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;

            // Check if the location is within the YZU campus
            if (latitude >= 24.968 && latitude <= 24.972 && longitude >= 121.267 && longitude <= 121.273) {
            output.innerHTML = "<p>You are inside the YZU campus</p>";
            } else {
            output.innerHTML = "<p>You are outside the YZU campus</p>";
            stopMonitoring();
            }

            // Display latitude, longitude, and timestamp
            output.innerHTML += "<p>Latitude: " + latitude + "</p>";
            output.innerHTML += "<p>Longitude: " + longitude + "</p>";
            output.innerHTML += "<p>Timestamp: " + new Date(position.timestamp) + "</p><br>";

            // Save the record
            var record = {
                latitude: latitude,
                longitude: longitude,
                timestamp: new Date(position.timestamp)
            };
            var records = localStorage.getItem("trackedCoordinates");
            if (records) {
                records = JSON.parse(records);
                records.push(record);
            } else {
                records = [record];
            }

            // Save and display all records for today
            var today = new Date().toLocaleDateString();
            var todayRecords = records.filter(function(record) {
                return new Date(record.timestamp).toLocaleDateString() === today;
            });

            localStorage.setItem("trackedCoordinates", JSON.stringify(records));
            output.innerHTML += "<p>Today's Records:</p>";
            todayRecords.forEach(function(record) {
                output.innerHTML += "<p>Latitude: " + record.latitude + "</p>";
                output.innerHTML += "<p>Longitude: " + record.longitude + "</p>";
                output.innerHTML += "<p>Timestamp: " + record.timestamp + "</p><br>";
            });
            localStorage.setItem("trackedCoordinates", JSON.stringify(records));
        }

        function error() {
            output.innerHTML = "Unable to retrieve your location";
        }

        var geo_options = {
            enableHighAccuracy: true,
            maximumAge: 30000,
            timeout: 27000,
        };

        function startMonitoring() {
            output.innerHTML = "<p>Monitoring started...</p>";
            watchId = navigator.geolocation.watchPosition(success, error, geo_options);
        }

        function stopMonitoring() {
            output.innerHTML = "<p>Monitoring stopped</p>";
            navigator.geolocation.clearWatch(watchId);
            localStorage.removeItem("trackedCoordinates");
        }

        function prompt(window, pref, message, callback) {
            let branch = Components.classes[
                "@mozilla.org/preferences-service;1"
            ].getService(Components.interfaces.nsIPrefBranch);

            if (branch.getPrefType(pref) === branch.PREF_STRING) {
                switch (branch.getCharPref(pref)) {
                case "always":
                    return callback(true);
                case "never":
                    return callback(false);
                }
            }

            let done = false;

            function remember(value, result) {
                return function () {
                done = true;
                branch.setCharPref(pref, value);
                callback(result);
                };
            }

            let self = window.PopupNotifications.show(
                window.gBrowser.selectedBrowser,
                "geolocation",
                message,
                "geo-notification-icon",
                {
                label: "Share Location",
                accessKey: "S",
                callback: function (notification) {
                    done = true;
                    callback(true);
                },
                },
                [
                {
                    label: "Always Share",
                    accessKey: "A",
                    callback: remember("always", true),
                },
                {
                    label: "Never Share",
                    accessKey: "N",
                    callback: remember("never", false),
                },
                ],
                {
                eventCallback: function (event) {
                    if (event === "dismissed") {
                    if (!done) callback(false);
                    done = true;
                    window.PopupNotifications.remove(self);
                    }
                },
                persistWhileVisible: true,
                },
            );
            }

            prompt(
            window,
            "extensions.foo-addon.allowGeolocation",
            "Foo Add-on wants to know your location.",
            function callback(allowed) {
                alert(allowed);
            },
            );

    </script>
</body>
</html>
